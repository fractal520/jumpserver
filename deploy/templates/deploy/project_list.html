{% extends '_base_list.html' %}
{% load i18n static %}
{% block table_search %}{% endblock %}
{% block content_left_head %}{% endblock %}
{% block table_container %}
    <table class="table table-striped table-bordered table-hover" id="task_table">
        <thead>
            <tr>
                <th>ID</th>
                <th>项目名称</th>
                <th>项目描述</th>
                <th>创建时间</th>
                <th>操作</th>
            </tr>
        </thead>
    </table>

    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Modal title</h4>
                </div>
                <form class="form-update" method="post">
                    {% csrf_token %}
                    <div class="modal-body form-group">
                        <label for="name">项目名称</label>
                        <input class="form-control" type="text" id="name" name="name"/>
                        <label for="desc">项目描述</label>
                        <input class="form-control" type="text" id="desc" name="desc"/>
                    </div>
                    <div class="modal-footer form-group">
                        <button type="reset" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary btn-update" id="">Save changes</button>
                    </div>
                </form>

            </div>
        </div>
    </div>
{% endblock %}
{% block custom_foot_js %}
    <script>
        jQuery(document).ready(function(){

            let options = {
                ele: $('#task_table'),
                ajax_url: "{% url 'api-deploy:project_list' %}",
                columnDefs: [
                    {targets :4, createdCell: function (td, cellData) {
                        let delete_btn = '<a class="btn btn-xs m-l-xs btn-danger btn-delete" href="javascript:void(0)" project_id="99999">删除</a>'.replace("99999", cellData);
                        let update_btn = '<a class="btn btn-xs m-l-xs btn-primary btn-show" href="javascript:void(0)" project_id="99999">修改</a>'.replace("99999", cellData);
                        $(td).html(delete_btn + update_btn);
                    }}
                ],
                columns: [
                    {data: 'id'},
                    {data: 'name'},
                    {data: 'desc'},
                    {data: 'create_time'},
                    {data: 'id'}
                ]
            };
            var TaskTable = jumpserver.initDataTable(options);

        });

        $("body").on('click', '.btn-delete', function () {
            let project_id = $(this).attr('project_id');
            if(confirm("确定该删除任务?")){
                //确认后的任务
                let the_url ="{% url 'api-deploy:project_delete' pk=DEFAULT_PK %}".replace('{{ DEFAULT_PK }}', project_id);
                $.ajax({
                    url: the_url,
                    async: false,
                    type: 'DELETE',
                    dataType: 'json',
                    contentType: "application/x-www-form-urlencoded",
                    success: function (result) {
                        window.location.reload()
                    },
                    error: function (result) {
                        alert("Unknow Error")
                    }
                });
            }
        });

        $("body").on('click', '.btn-show', function () {
            $('#myModal').modal("show");
            let project_id = $(this).attr('project_id');
            let the_url = "{% url 'api-deploy:project_update' pk=DEFAULT_PK %}".replace('{{ DEFAULT_PK }}', project_id);
            $.ajax({
                url: the_url,
                async: false,
                type: 'GET',
                dataType: 'json',
                contentType: "application/x-www-form-urlencoded",
                success: function (result) {
                    $("#name").attr("value", result.name);
                    $("#desc").attr("value", result.desc);
                    $(".btn-update").attr("id", result.id)
                },
                error: function (result) {
                    alert("Unknow Error")
                }
            });

            $("body").on('click', '.btn-update', function () {
                let project_id = $(this).attr('id');
                let the_url = "{% url 'api-deploy:project_update' pk=DEFAULT_PK %}".replace('{{ DEFAULT_PK }}', project_id);
                let form_data = $('.form-update').serializeArray();
                console.log(form_data)
                $.ajax({
                    url: the_url,
                    async: false,
                    type: 'PUT',
                    data: form_data,
                    dataType: 'json',
                    contentType: "application/x-www-form-urlencoded",
                    success: function (result) {
                        alert("OK");
                        window.location.reload()
                    },
                    error: function (result) {
                        alert("Unknow Error")
                    }
                });
            });

        });

    </script>
{% endblock %}