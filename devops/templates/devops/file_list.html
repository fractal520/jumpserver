{% extends '_base_list.html' %}
{% load i18n static %}
{% block custom_head_css_js %}
    <link href="{% static "css/plugins/datatables/datatables.min.css" %}" rel="stylesheet">
    <link href="{% static 'css/plugins/select2/select2.min.css' %}" rel="stylesheet">
    <script src="{% static 'js/plugins/select2/select2.full.min.js' %}"></script>
    <script src="{% static "js/plugins/datatables/datatables.min.js" %}"></script>
    <style type="text/css">
        .select2-drop {
            z-index: 10050 !important;
        }


        /*防止select2不会自动失去焦点*/
        .select2-container {
            z-index: 16000 !important;
        }

        .select2-drop-mask {
            z-index: 15990 !important;
        }

        .select2-drop-active {
            z-index: 15995 !important;
        }
    </style>
{% endblock %}

{% block content_left_head %}
    <div class="uc pull-left m-l-5 m-r-5">
        <div class="btn-group">
            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">功能列表
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" role="menu">
                <li class="disabled"><a href="#">任务中心</a></li>
                <!--<li class=""><a href="{% url 'devops:index' %}">任务中心</a></li>-->
                <li class=""><a href="{% url 'devops:play-task-list' %}">PlayBook任务列表</a></li>
                <li class="active"><a href="{% url 'devops:filecheck' %}">对账文件检查状态</a></li>
                <li class="divider"></li>
                <li><a id="btn-create-form" href="javascript:void(0)" class="btn-create-form" data-toggle="modal" data-target="#FileCheckCreateModal">创建文件检查任务</a></li>
            </ul>
        </div>
    </div>
{% endblock %}
{% block table_search %}{% endblock %}
{% block table_container %}
    <table class="table table-striped table-bordered table-hover" id="task_table">
        <thead>
            <tr>
                <th class="text-center">任务ID</th>
                <th class="text-center">城市</th>
                <th class="text-center">渠道</th>
                <th class="text-center">节点IP</th>
                <th class="text-center">节点类型</th>
                <th class="text-center">上一次检查文件</th>
                <th class="text-center">上一次检查时间</th>
                <th class="text-center">下一次检查时间</th>
                <th class="text-center">文件日期正负</th>
                <th class="text-center">检查状态</th>
                <th class="text-center">定时任务状态</th>
                <th class="text-center">定时任务类型</th>
                <th class="text-center">操作</th>
            </tr>
        </thead>
    </table>

    <!-- FileCheckCreateModal -->
    <div class="modal fade" id="FileCheckCreateModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">创建检查任务</h4>
                </div>
                <form class="form-create" method="post">
                    {% csrf_token %}
                    <div class="modal-body form-group">

                        <h3>基本设置</h3>

                        <label for="city">企业名称</label>
                        <input class="form-control" type="text" id="city" name="city"/>
                        <label for="way">渠道</label>
                        <select class="form-control" id="way" name="way">
                            <option value="upload">上传</option>
                            <option value="download">下载</option>
                        </select>
                        <label for="file_path">文件路径</label>
                        <input class="form-control" type="text" id="file_path" name="file_path" placeholder="/path/to/"/>
                        <label for="file_format">文件格式</label>
                        <input class="form-control" type="text" id="file_format" name="file_format" placeholder="test.{}.txt"/>
                        <label for="time_format">日期格式</label>
                        <input class="form-control" type="text" id="time_format" name="time_format" placeholder="%Y-%m-%d"/>

                        <h3>节点设置</h3>

                        <div class="form-group">
                            <label class="" for="id_assets">{% trans 'Assets' %}</label>
                            <div class="">
                                <select data-placeholder="请选择" id="id_assets" name="asset_id" class="select2 form-control"
                                        tabindex="4" style="width:300px;">
                                </select>
                            </div>
                        </div>

                        <h3>任务设置</h3>

                        <label for="job_name">任务名称</label>
                        <input class="form-control" type="text" id="job_name" name="job_name"/>
                        <label for="trigger">触发器</label>
                        <select class="form-control" id="trigger" name="trigger">
                            <option value="cron">定时任务</option>
                            <option value="interval">循环任务</option>
                        </select>
                        <label for="time_delta">文件日期时间差</label>
                        <select class="form-control" id="time_delta" name="time_delta">
                            <option value="0">当天</option>
                            <option value="-2">2天前</option>
                            <option value="-1">1天前</option>
                            <option value="1">1天后</option>
                            <option value="2">2天后</option>
                        </select>


                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary btn-create-job">Save changes</button>
                    </div>
                </form>

            </div>
        </div>
    </div>

{% endblock %}
{% block content_bottom_left %}
{% endblock %}


{% block custom_foot_js %}
    <script>
        $(document).ready(function () {
            $.fn.modal.Constructor.prototype.enforceFocus = function() {};
            var the_url = "{% url 'api-devops:file_check_list' %}";
            $.get(the_url, function(result){
                console.log(result)
            });

            let options = {
                ele: $('#task_table'),
                columns: [
                    {data: 'job_id'}, {data: 'city'}, {data: "way"}, {data: "node_ip"}, {data: "node_type"}, {data: 'last_check_file'},{data: "last_check_time"},
                    {data: "next_run_time"}, {data: "time_delta"}, {data: "check_status"}, {data: "run_status"}, {data: 'trigger'}, {data: 'job_id'}
                    ],
                ajax_url: '{% url "api-devops:file_check_list" %}',
                columnDefs: [
                    {targets: 9, createdCell: function (td, cellData) {
                        if (cellData) {
                            let html = '<i class="fa fa-check text-navy"></i>';
                            $(td).html(html);
                        }else {
                            let html = '<i class="fa fa-times text-danger"></i>';
                            $(td).html(html);
                        }
                    }},
                    {targets: 10, createdCell: function (td, cellData) {
                        if (cellData) {
                            let html = '<i class="fa fa-check text-navy"></i>';
                            $(td).html(html);
                        }else {
                            let html = '<i class="fa fa-times text-danger"></i>';
                            $(td).html(html);
                        }
                    }},
                    {targets :12, createdCell: function (td, cellData) {
                        let delete_btn = '<a class="btn btn-xs btn-danger m-l-xs btn-delete" href="javascript:void(0)" job_id="99999">{% trans "Delete" %}</a>'.replace("99999", cellData);
                        let update_btn = '<a href="{% url "devops:filecheck-update" pk=DEFAULT_PK %}" class="btn btn-xs btn-primary m-l-xs btn-role-update">{% trans "Update" %}</a>'.replace('{{ DEFAULT_PK }}', cellData);
                        //console.log(cellData);
                        $(td).html(delete_btn + update_btn);
                    }}
                ]
            };
            var TaskTable = jumpserver.initDataTable(options);
        });

        $("body").on('click', '.btn-delete', function () {
            let job_id = $(this).attr('job_id');
            console.log(job_id);
            if(confirm("确定该删除任务?")){
                //确认后的任务
                let the_url ="{% url 'api-devops:file_check_delete' pk=DEFAULT_PK %}".replace('{{ DEFAULT_PK }}', job_id);
                $.ajax({
                    url: the_url,
                    async: false,
                    type: 'GET',
                    dataType: 'json',
                    contentType: "application/x-www-form-urlencoded",
                    success: function (result) {
                        alert(result.msg);
                        window.location.reload()
                    }
                });
            }
        });

        $("body").on('click', '.btn-create-job', function(){

            console.log("click");
            let form_data = $('.form-create').serializeArray();
            //alert(form_data);
            $.ajax({
                url: "{% url 'api-devops:file_check_add' %}",
                async: false,
                type: 'POST',
                dataType: 'json',
                contentType: "application/x-www-form-urlencoded",
                data: form_data,
                success: function (result) {
                    if (result.code === 200){
                        alert(result.msg);
                        window.location.reload()
                    }else{
                        alert(result.code + result.msg);
                    }
                },
                error: function (result) {
                    alert("Unknown error")
                }
            });
        });

        $('#FileCheckCreateModal').on('show.bs.modal', function (e) {

            $('#id_assets').select2({
                dropdownParent:$("#FileCheckCreateModal"),
                //ajax查询all assets
                ajax: {
                    url: '{% url 'api-devops:my-assets' %}',
                    dataType: 'json',
                    crossDomain: true,
                    processResults: function (data) {
                        let results = $(data).each(function (index, element) {
                            element.text = element.hostname + "(" + element.ip + ")"
                        });
                        return {results: results};//必须赋值给results并且必须返回一个obj
                    }
                }
            });

        })
    </script>
{% endblock %}