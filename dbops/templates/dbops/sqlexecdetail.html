{% extends '_base_list.html' %}
{% load i18n static %}
{% block table_search %}{% endblock %}
{% block content_left_head %}<a class="btn btn-xs btn-info btn-sql-rollback" data-toggle="modal" data-target="#sql_rollback_modal" work_id="{{ work_id }}">查看回滚语句</a>{% endblock %}
{% block table_container %}
<div id="sqlorderlist">
    <table class="table table-striped table-bordered table-hover " id="sql_table" >
        <thead>
            <tr>
                <th>SQL语句</th>
                <th>状态</th>
                <th>错误信息</th>
                <th>影响行数</th>
                <th>执行耗时</th>
            </tr>
        </thead>
        <tbody>
          {% for s in sqlrecords %}
            <tr>
                <td>{{s.sql}}</td>
                <td>{{s.state}}</td>
                <td>{{s.error}}</td>
                <td>{{s.affectrow}}</td>
                <td>{{s.execute_time}}</td>
            </tr>
          {% endfor %}
        </tbody>
    </table>
</div>
{% include 'dbops/_sql_rollback_modal.html' %}
{% endblock %}

{% block custom_foot_js %}
    <script>
        $(document).ready(function(){
         $(".btn-sql-rollback").click(function(){
            var work_id = $(this).attr("work_id");
            var the_url = '{% url 'api-dbops:rollback' pk=DEFAULT_PK %}'.replace('{{ DEFAULT_PK }}', work_id);
            $.ajax({
                type: "GET",
                contentType: "application/x-www-form-urlencoded",
                url: the_url,
                success:function (data) {
                    console.log("data is :"+ data);
                    var sql = '';
                    var trs = '';
                    var desc = {
                        'db': "数据库",
                        'rollback_sql': "回滚语句",
                    };
                    for(var i in desc){
                        if (i === 'rollback_sql') {
                            sql = data[i].join("<br/>");
                            trs += "<tr class='no-borders-tr'>\n" +
                              "<td>"+ desc[i] + ":</td>"+
                              "<td><b>"+ sql + "</b></td>\n" +
                              "</tr>";
                        }
                        else {
                            trs += "<tr class='no-borders-tr'>\n" +
                              "<td>"+ desc[i] + ":</td>"+
                              "<td><b>"+ (data[i] === null?'':data[i]) + "</b></td>\n" +
                              "</tr>";
                        }
                    }
                    $('#sql_rollback__tbody').html(trs)
                    console.log(data);
                }
            });
        });
    })
    </script>
{% endblock %}
