{% extends '_base_list.html' %}
{% load i18n static %}
{% block table_search %}{% endblock %}
{% block content_left_head %}<span class="label label-primary">SQL任务列表</span>{% endblock %}
{% block table_container %}
<div id="sqlorderlist">
    <table class="table table-striped table-bordered table-hover " id="sql_table" >
        <thead>
            <tr>
                <th>任务编号</th>
                <th>任务说明</th>
                <th>数据库</th>
                <th>是否备份</th>
                <th>提交时间</th>
                <th>提交人</th>
                <th>状态</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
          {% for s in sqlorders %}
            <tr>
                <td>{{s.work_id}}</td>
                <td>{{s.text}}</td>
                <td>{{s.dbinfo }}</td>
                <td>{{s.get_backup_display}}</td>
                <td>{{s.insert_date}}</td>
                <td>{{s.submit_user}}</td>
                {% if s.get_status_display == '未审核' %}
                <td><span class="label label-default">{{s.get_status_display}}</span></td>
                {% elif s.get_status_display == '已驳回' %}
                <td><span class="label label-warning">{{s.get_status_display}}</span></td>
                {% elif s.get_status_display == '未执行' %}
                <td><span class="label label-info">{{s.get_status_display}}</span></td>
                {% elif s.get_status_display == '执行成功' %}
                <td><span class="label label-success">{{s.get_status_display}}</span></td>
                {% elif s.get_status_display == '执行失败' %}
                <td><span class="label label-danger">{{s.get_status_display}}</span></td>
                {% endif %}
                <td>
                    <a class="btn btn-xs btn-primary btn-sql-handle" data-toggle="modal" data-target="#sql_order_detail_modal" work_id="{{ s.work_id }}">查看</a>
                </td>
            </tr>
          {% endfor %}
        </tbody>
    </table>
</div>
{% include 'dbops/_sql_order_detail_modal.html' %}
{% endblock %}
{% block custom_foot_js %}
    <script>
    $(document).ready(function(){
         $(".btn-sql-handle").click(function(){
            var work_id = $(this).attr("work_id");
            var the_url = '{% url 'api-dbops:exec' pk=DEFAULT_PK %}'.replace('{{ DEFAULT_PK }}', work_id);
            $.ajax({
                type: "GET",
                contentType: "application/x-www-form-urlencoded",
                url: the_url,
                success:function (data) {
                    var sql = '';
                    var trs = '';
                    var desc = {
                        'work_id': "任务编号",
                        'text':"任务说明",
                        'status': "任务状态",
                        'db': "数据库",
                        'sql': "SQL语句",
                    };
                    if(data.work_id === work_id){
                        for(var i in desc){
                            if (i ==='sql' ) {
                                sql = data[i].join(";<br/>");
                                trs += "<tr class='no-borders-tr'>\n" +
                                  "<td>"+ desc[i] + ":</td>"+
                                  "<td><b>"+ sql + "</b></td>\n" +
                                  "</tr>";
                            }
                            else {
                                trs += "<tr class='no-borders-tr'>\n" +
                                  "<td>"+ desc[i] + ":</td>"+
                                  "<td><b>"+ (data[i] === null?'':data[i]) + "</b></td>\n" +
                                  "</tr>";
                            }
                        }
                    }
                    $('#sql_order_detail_tbody').html(trs)
                    $('.btn-sql-exec').attr({"work_id":work_id,"work_status":data["status"]})
                    $('.btn-sql-reject').attr({"work_id":work_id,"work_status":data["status"]})
                    $('.btn-sql-agree').attr({"work_id":work_id,"work_status":data["status"]})
                    if (data["status"] === "未执行"){
                        $('.btn-sql-exec').attr('disabled',false);
                    }
                    else if(data["status"] === "未审核"){
                        $('.btn-sql-reject').attr('disabled',false);
                        $('.btn-sql-agree').attr('disabled',false);
                    }
                    else {
                        $('.btn-sql-reject').attr('disabled',true);
                        $('.btn-sql-agree').attr('disabled',true);
                        $('.btn-sql-exec').attr('disabled',true);
                    }
                    console.log(data)
                }
            });
        });
    })
    $(document).ready(function () {
        $(".btn-sql-exec").click(function(){
            var work_id = $(this).attr("work_id");
            var the_url = '{% url 'api-dbops:exec' pk=DEFAULT_PK %}'.replace('{{ DEFAULT_PK }}', work_id);
            $.ajax({
                type: "POST",
                contentType: "application/x-www-form-urlencoded",
                url: the_url,
                success:function (data) {
                    console.log(data)
                }
            });
            window.location.reload();
        });
        $(".btn-sql-agree").click(function(){
            var work_id = $(this).attr("work_id");
            var the_url = '{% url 'api-dbops:audit' work_id=DEFAULT_PK %}'.replace('{{ DEFAULT_PK }}', work_id);
            var data = {status: 2};
            $.ajax({
                type: "PUT",
                contentType: "application/x-www-form-urlencoded",
                url: the_url,
                data: data,
                success:function (data) {
                    console.log(data)
                }
            });
            window.location.reload();
        });
        $(".btn-sql-reject").click(function(){
            var work_id = $(this).attr("work_id");
            var the_url = '{% url 'api-dbops:audit' work_id=DEFAULT_PK %}'.replace('{{ DEFAULT_PK }}', work_id);
            var data = {status: 1};
            $.ajax({
                type: "PUT",
                contentType: "application/x-www-form-urlencoded",
                url: the_url,
                data: data,
                success:function (data) {
                    console.log(data)
                }
            });
            window.location.reload();
        });
    });

    </script>
{% endblock %}
